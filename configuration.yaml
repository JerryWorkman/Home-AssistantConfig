# NOTE:
# Check Envisalink connection if system does not start

default_config:

homeassistant:
  name:                              Home
#  base_url:                          home.jerryworkman.com:8123
  latitude:                          !secret LATITUDE
  longitude:                         !secret LONGITUDE
  elevation:                         1057
  unit_system:                       imperial
  time_zone:                         America/New_York
  customize:                         !include customize.yaml
  packages:                          !include_dir_named packages
#  mobile_app:

  auth_providers:
    - type: homeassistant
    - type: legacy_api_password
      api_password: !secret API_PASSWORD
    - type: trusted_networks
      trusted_networks:
        - 192.168.10.0/24
        - 127.0.0.1/32
        - fd00::/8


  # shell_command.lovelace_gen
  customize_glob:
    "sensor.*alarm*":
      hidden: true
    "sensor.*burglar*":
      hidden: true
    "sensor.*sourcenodeid*":
      hidden: true
    "sensor.*power_management":
      hidden: true
    "sensor.*alarm_level*":
      hidden: true
    "sensor.*alarm_type*":
      hidden: true
#    "*sensor.*temphygro_alarm*":
#      hidden: true
#    "sensor.dark_sky*":
#      hidden: true
#    "switch.*":
#      custom_ui_state_card:         state-card-custom-ui
      
# Enables the frontend
frontend:
  javascript_version:                latest
#  extra_html_url:
#    - /local/custom_ui/state-card-custom-ui.html
#    - /local/custom_ui/state-card-tiles.html
#  extra_html_url_es5:
#    - /local/custom_ui/state-card-custom-ui-es5.html
#    - /local/custom_ui/state-card-tiles.html

#lovelace:
#  mode: yaml

system_health:

logger:
  default:                           warning
  logs:
    lock:                            debug
    customize_glob:                  debug
    statistics:                      debug
#    iperf3:                          debug
#    homeassistant.components.automation:        info
    homeassistant.components.camera: critical
    input_boolean:                   debug
#    influxdb:                        debug
#    notify:                         debug
    notify.livingroom_tv:            debug
    media_player.livingroom_tv:      debug
#    homeassistant.components.rfxtrx: debug
#    homeassistant.components.zwave: debug
#    zwave.front_door_lock:          debug
#    custom_components.alarm_control_panel.bwalarm: debug
#    flashing_switch:                debug
#    homeassistant.components.http:  warning
#    homeassistant.components.mqtt:  debug
#    sensor.power_meter:             debug
#    custom_components.sensor.ambient: debug
#    custom_components.countdown_timer.sensor: debug
#    sensor.torque:                  debug
#    hdmi_cec:                       debug
#    components.climate.nest:        debug
#    components.binary_sensor.nest:  debug
#    components.sensor.envisalink:   debug

# Show links to resources in log and frontend
#introduction:

# Enables configuration UI
config:

# Enables support for tracking state changes over time.
recorder:
  db_url:                            !secret DB_URL
  # Delete events and states older than 7 days every day
  purge_interval:                    1
  purge_keep_days:                   7
  exclude:
    domains:
      - automation
      - camera
      - device_tracker
      - input_text
      - media_player
      - scene
      - script
      - weblink
      - updater
#      - glances
    entities:
      - sun.sun
      - sensor.date
      - sensor.time
      - sensor.dark_sky_apparent_temperature
      - sensor.dark_sky_summary
      - sensor.dark_sky_daily_summary
      - sensor.dark_sky_hourly_summary
      - sensor.dark_sky_humidity
      - sensor.dark_sky_humidity_1
      - sensor.dark_sky_humidity_7
      - sensor.dark_sky_icon
      - sensor.dark_sky_icon_1
      - sensor.dark_sky_icon_7
      - sensor.dark_sky_minutely_summary
      - sensor.dark_sky_nearest_storm_bearing
      - sensor.dark_sky_nearest_storm_distance
      - sensor.dark_sky_precip_intensity
      - sensor.dark_sky_precip_intensity_1
      - sensor.dark_sky_precip_intensity_7
      - sensor.dark_sky_precip_probability
      - sensor.dark_sky_precip_probability_1
      - sensor.dark_sky_precip_probability_7
      - sensor.dark_sky_pressure
      - sensor.dark_sky_pressure_1
      - sensor.dark_sky_pressure_7
      - sensor.dark_sky_temperature
      - sensor.dark_sky_visibility
      - sensor.dark_sky_wind_bearing
      - sensor.dark_sky_wind_bearing_1
      - sensor.dark_sky_wind_bearing_7
      - sensor.dark_sky_wind_speed
      - sensor.dark_sky_wind_speed_1
      - sensor.dark_sky_wind_speed_7
      
      - sensor.back_driveway_pir_alarm_level
      - sensor.back_garage_door_tilt_alarm_level
      - sensor.front_garage_door_tilt_alarm_level
      - sensor.fr_pir_2_alarm_level
      - sensor.fr_pir_alarm_level
      - sensor.garage_back_pir_alarm_level
      - sensor.garage_side_pir_alarm_level
      - sensor.garage_temphygro_alarm_level
#      - sensor.kwikset_touchpad_electronic_deadbolt_alarm_level
      - sensor.lr_pir_alarm_level
      - sensor.patio_pir_alarm_level
      - sensor.back_driveway_pir_alarm_type
      - sensor.back_garage_door_tilt_alarm_type
      - sensor.front_garage_door_tilt_alarm_type
      - sensor.fr_pir_2_alarm_type
      - sensor.fr_pir_alarm_type
      - sensor.garage_back_pir_alarm_type
      - sensor.garage_side_pir_alarm_type
      - sensor.garage_temphygro_alarm_type
#      - sensor.kwikset_touchpad_electronic_deadbolt_alarm_type
      - sensor.lr_pir_alarm_type
      - sensor.patio_pir_alarm_type
      - sensor.back_driveway_pir_burglar
      - sensor.back_garage_door_tilt_burglar
      - sensor.front_garage_door_tilt_burglar
      - sensor.fr_pir_2_burglar
      - sensor.fr_pir_burglar
      - sensor.garage_back_pir_burglar
      - sensor.garage_side_pir_burglar
      - sensor.lr_pir_burglar
      - sensor.patio_pir_burglar
      - sensor.back_driveway_pir_sourcenodeid
      - sensor.back_garage_door_tilt_sourcenodeid
      - sensor.front_garage_door_tilt_sourcenodeid
      - sensor.fr_pir_2_sourcenodeid
      - sensor.fr_pir_sourcenodeid
      - sensor.garage_back_pir_sourcenodeid
      - sensor.garage_side_pir_sourcenodeid
      - sensor.lr_pir_sourcenodeid
      - sensor.patio_pir_sourcenodeid
#      - zwave.kwikset_touchpad_electronic_deadbolt_battery
      - sensor.back_driveway_countdown_timer
      - sensor.family_room_countdown_timer
      - sensor.garage_countdown_timer
      - sensor.living_room_countdown_timert
      - sensor.patio_v
      - input_number.internet_traffic_delta_in
      - input_number.internet_traffic_delta_out

python_script:

influxdb:
  host:                              127.0.0.1
  default_measurement:               state
  include:
    entities:
    #power
      - sensor.line_voltage
      - sensor.power_meter
      - sensor.meter_avg_for_last_hour
      - sensor.daily_power_cost
      - sensor.humidifier
      - sensor.up_heat_pump
      - sensor.down_air_handler
      - sensor.down_heat_pump
      #temp/humidity
      - sensor.living_room_thermostat_temperature
      - sensor.up_temperature
      - sensor.fr_temperature
      - sensor.fr_temperature_humidity
      - sensor.up_temperature_humidity
      - sensor.garage_temperature
      - sensor.garage_temperature_humidity
      - sensor.out_temperature
      - sensor.out_temperature_humidity
      #bandwidth
      - binary_sensor.ping_google
      - sensor.speedtest_download
      - sensor.lan_internet_down
      - sensor.lan_internet_up
      - sensor.people_home
      
http:
  base_url:                          !secret BASE_URL
#  ssl_certificate:                  /home/homeassistant/.homeassistant/certbot/fullchain.pem
#  ssl_key:                          /home/homeassistant/.homeassistant/certbot/privkey.pem

#customizer:
#  custom_ui:                        local
  
# Checks for available updates
updater:
  include_used_components: true

# Discover some devices automatically
discovery:
  ignore:
    - philips_hue

# Phillips Hue
#hue:
#  bridges:
#    - host: 192.168.10.191

# Allows you to issue voice commands from the frontend in enabled browsers
#conversation:

websocket_api:

# Enables support for tracking state changes over time.
history:
  include:
    domains:
      - sensor
      - binary_sensor
      - switch
#  exclude:
#    entities:
#      group.darksky

# View all events in a logbook
logbook:
  exclude:
    entities:
      - input_number.internet_traffic_delta_in
      - input_number.internet_traffic_delta_out
      
# Text to speech
tts:
  - platform:                        google_translate
  
#  - platform:                       amazon_polly
#    aws_access_key_id:              !secret AWS_ACCESS_KEY_ID
#    aws_secret_access_key:          !secret AWS_SECRET_ACCESS_KEY
#    profile_name:                   default
#    region_name:                    "us-east-1"
#    voice:                          Joanna

#  - platform:                       picotts
#    language:                       "en-US"
  
# Track the sun
sun:

# In custom_components/battery_state.py
#battery_state:
#  include:
#    - sensor.garage_door_burglar_3
#    - sensor.office_multisensor_temperature_5
#    - sensor.frontroom_multisensor_temperature_4

# In custom_components/humidity_state.py
humidity_state:

cloud:
#  alexa:
#    filter:
#      include_entities:
#        - light.kitchen
#        - light.kitchen_left
#      include_domains:
#        - switch
#      exclude_entities:
#        - switch.outside
#    entity_config:
#      light.kitchen:
#        name:                       Custom Name for Alexa
#        description:                The light in the kitchen
#      switch.stairs:
#        display_categories:         LIGHT

wemo:
  discovery: true
#  static:
#    - 192.168.10.166
#    - 192.168.10.223

# This is HA alarm
#alarm_control_panel:
#  platform:                         manual
##  code:                            0127
#  pending_time:                     60
##  disarm_after_trigger:            True

#ring:
#  username: !secret RING_USERNAME
#  password: !secret RING_PASSWORD

#sensor version:
#  platform: version

#binary_sensor:
#  platform: ring
#  scan_interval: 20
#  monitored_conditions:
#    - ding
#    - motion
    
# alarm_control_panel:                 !include alarm.yaml

#Mike's mFi
#switch:
#   platform:                        mfi
#   host:                            mcoyne50.ddns.net
#   username:                        admin
#   password:                        admin


#For Alexa
#emulated_hue:

# Weather Prediction
sensor yr:
  platform:                          yr

sensor time_date:
  - platform:                        time_date
    display_options:
      - 'time'

twilio:
  account_sid:                       !secret TWILLIO_ACCOUNT_SID
  auth_token:                        !secret TWILLIO_AUTH_TOKEN

# Example configuration.yaml entry
webostv:
  host: 192.168.10.133
  name: Living Room TV
  turn_on_action:
    service: persistent_notification.create
    data:
      message: "Turn on action"
  customize:
    sources:
      - livetv
      - youtube
      - makotv
      - netflix
      - espn+

notify:
  - name:                            jerry
    platform:                        pushbullet
    api_key:                         !secret PUSHBULLET_API_KEY
  - name:                            twilio_sms
    platform:                        twilio_sms
    from_number:                     !secret TTWILIO_SMS_FROM_NUMBER
  - name:                            livingroom_tv
    platform:                        webostv
    host:                            192.168.10.133
    icon:                            /api/media_player_proxy/media_player.livingroom_tv?token=e5ad6c4333f7bb34d753b1d094e76ecded2ddc43d5b9f39fe729b9057055d8a1&cache=aca1dceff42e2f1d
    filename:                        webostv.conf
    
shell_command:
  sound_alarm:                       "mplayer -loop 1 /home/homeassistant/.homeassistant/alarm.mp3"
  sound_alarm_5:                     "mplayer -loop 5 /home/homeassistant/.homeassistant/alarm.mp3"
  door_bell:                         "mplayer -loop 1 /home/homeassistant/.homeassistant/doorbell-2.mp3"

switch door_bell:
  platform:                          command_line
  switches:
    door_bell:
      command_on:                    "mplayer -loop 1 /home/homeassistant/.homeassistant/doorbell-2.mp3"
    
switch alarm:
  platform:                          command_line
  switches:
    alarm:
      command_on:                    "mplayer -loop 1 /home/homeassistant/.homeassistant/alarm.mp3"
    alarm5:
      command_on:                    "mplayer -loop 5 /home/homeassistant/.homeassistant/alarm.mp3"
    
ifttt:
  key:                               !secret IFTTT_KEY

# sensor cpu:
#   - platform:                      cpuspeed

panel_iframe:
#  emoncms:
#    title:                          'EmonCMS'
#    icon:                           mdi:chart-line
#    url:                            !secret EMONCMS_URL

  configurator:
    title: Configurator
    icon: mdi:wrench
    url: http://192.168.10.2:3218

  charts:
    title:                           Google Charts
    url:                             /local/bower_components/google-chart/demo/index.html

#  iron_flex_layout:
#    title:                           Polymer Iron Flex Layouts
#    url:                             /local/iron-flex-layout.html

#  basic_flex_layout:
#    title:                           Basic Flex Layouts
#    url:                             /local/basic-flex.html

#  wc_guages:
#    title:                          Web Components Guages
#    icon:                           mdi:hand-pointing-right
#    url:                            /local/wc-guages.html

  power:
    title:                           Power
    icon:                            mdi:checkbox-marked-outline
    url:                             !secret POWER_URL

#  lovelace:
#    title:                           Lovelace UI
#    icon:                            mdi:hand-pointing-right
#    url:                             /lovelace

#  coolie_guages:
#    title:                           Coolie Guages
#    icon:                            mdi:hand-pointing-right
#    url:                             /local/coolie_guages.html

  google_guages:
    title:                           Google Guages
    icon:                            mdi:hand-pointing-right
    url:                             /local/google-guages.html

  ha_websocket:
    title:                           Websocket Panel
    icon:                            mdi:hand-pointing-right
    url:                             /local/ha-websocket.html
    
panel_custom:
  - name:                            alarm
    sidebar_title:                   Alarm
    sidebar_icon:                    mdi:security-home
    config:
      alarmid:                       alarm_control_panel.house

  - name:                            react
    sidebar_title:                   TodoMVC
    sidebar_icon:                    mdi:checkbox-marked-outline
    url_path:                        react
    config:
      title:                         ToDo

#  - name:                            lovelace
#    sidebar_title:                   Lovelace UI
#    sidebar_icon:                    mdi:hand-pointing-right
#    url_path:                        lovelace

#  - name:                           hello
#    sidebar_title:                  Hello World
#    sidebar_icon:                   mdi:hand-pointing-right
#    url_path:                       hello
#    config:
#      who:                          Jerry

#  - name:                            sensor
#    sidebar_title:                   Power Meter
#    sidebar_icon:                    mdi:hand-pointing-right
#    config:
#      sensor:                        sensor.power_meter

#  - name:                            show_sensors
#    sidebar_title:                   Power Sensors
#    sidebar_icon:                    mdi:hand-pointing-right
#    config:
#      sensors:                       sensor.power_meter,sensor.humidifier,sensor.up_heat_pump,sensor.down_air_handler,sensor.down_heat_pump

#ffmpeg:
#  ffmpeg_bin:                       /usr/bin/avconv
ffmpeg:
  ffmpeg_bin:                        /usr/bin/ffmpeg
  
amcrest:
  # Living Room
  - host:                            192.168.10.51
    username:                        admin
    password:                        !secret AMCREST_PASSWORD
    name:                            Living Room
    sensors:
#      - motion_detector
      - sdcard

  # Front Garage
  - host:                            192.168.10.57
    username:                        admin
    password:                        !secret AMCREST_GARAGE_PASSWORD
    name:                            Front Garage
    sensors:
      - sdcard

  # Garage
  - host:                            192.168.10.55
    name:                            Garage
    username:                        jerry
    password:                        !secret AMCREST_GARAGE_PASSWORD
    #sensors:
    #  - sdcard

# mqtt:                              !include mqtt.yaml
mqtt:
#  broker:                           192.168.10.190
  broker:                            127.0.0.1
  port:                              1883
  client_id:                         hass
  keepalive:                         60
#  username:                          !secret MQTT_USERNAME
  password:                          !secret MQTT_PASSWORD
#  protocol:                         3.1
#  certificate:                      /home/paulus/dev/addtrustexternalcaroot.crt
  birth_message:
    topic: "tele/sonos1/LWT"
    payload: "Online"
    qos: 1
    retain: true
  will_message:
    topic: "tele/sonos1/LWT"
    payload: "Offline"
    qos: 1
    retain: true

switch mqtt_garage_front:
  - platform: mqtt
    name: "Front Garage Door Switch"
    state_topic: "stat/sonoff1/RESULT"
    value_template: "{{ value_json.POWER }}"
    command_topic: "cmnd/sonoff1/POWER"
    availability_topic: "tele/sonoff1/LWT"
    qos: 1
    payload_on: "ON"
    payload_off: "OFF"
    payload_available: "Online"
    payload_not_available: "Offline"
    retain: false

switch mqtt_garage_back:
  - platform: mqtt
    name: "Back Garage Door Switch"
    state_topic: "stat/sonoff4/RESULT"
    value_template: "{{ value_json.POWER }}"
    command_topic: "cmnd/sonoff4/POWER"
    availability_topic: "tele/sonoff4/LWT"
    qos: 1
    payload_on: "ON"
    payload_off: "OFF"
    payload_available: "Online"
    payload_not_available: "Offline"
    retain: false

sensor mqtt:

  - platform:                        mqtt
    state_topic:                     'home/power/voltage/V_VOLTS'
    name:                            'Line Voltage'
    unit_of_measurement:             'Volts'
    #qos:                            1
    value_template:                '{{ value | round(1) }}'

  - platform:                        mqtt
    state_topic:                     'home/power/meter/V_WATTS'
    name:                            'Power Meter'
    unit_of_measurement:             'Watts'
    #qos:                            1
    value_template:                  '{{ [value | float, 0.0] | max | round(0) }}'

  - platform:                        mqtt
    state_topic:                     'home/power/humidifier/V_WATTS'
    name:                            'Humidifier'
    #qos:                            1
    unit_of_measurement:             'Watts'
    value_template:                 '{{ [0.0, value | float] | max | round(0) }}'

  - platform:                        mqtt
    state_topic:                     'home/power/uphp/V_WATTS'
    name:                            'Up Heat Pump'
    #qos:                            1
    unit_of_measurement:             'Watts'
    value_template:                  '{%set mylist = value|float, 0.0%} {{ mylist|max|round(0) }}'

  - platform:                        mqtt
    state_topic:                     'home/power/downah/V_WATTS'
    name:                            'Down Air Handler'
    #qos:                            1
    unit_of_measurement:             'Watts'
    value_template:                 '{{ [0.0, value | float] | max | round(0) }}'

  - platform:                        mqtt
    state_topic:                     'home/power/downhp/V_WATTS'
    name:                            'Down Heat Pump'
    #qos:                            1
    unit_of_measurement:             'Watts'
    value_template:                  "{{ [0.0, value | float] | max | round(0) }}"

# tele/sonoff/RESULT {"RfReceived":{"Sync":12570,"Low":450,"High":1230,"Data":"EBC9FE","RfKey":"None"}}
  - platform: mqtt
    name: 'rfx433'
    state_topic: "tele/sonoff/RESULT"
    value_template: '{{value_json.RfReceived.Data}}'
    expire_after: 1
    

# TODO: Use packages here
# monitor.sh

  - platform: mqtt
#    state_topic: 'monitor/livingroom/94:76:B7:80:B2:86'
    state_topic: 'monitor/livingroom/3C:28:6D:00:BC:55'
    value_template: '{{ value_json.confidence }}'
    unit_of_measurement: '%'
    name: 'Jerry Home'
    # gravatar: jerry.workman@gmail.com

  - platform: mqtt
#    state_topic: 'monitor/familyroom/94:76:B7:80:B2:86'
    state_topic: 'monitor/familyroom/3C:28:6D:00:BC:55'
    value_template: '{{ value_json.confidence }}'
    unit_of_measurement: '%'
    name: 'Jerry Family Room'

  - platform: mqtt
    state_topic: 'monitor/livingroom/90:60:F1:4E:07:61'
    value_template: '{{ value_json.confidence }}'
    unit_of_measurement: '%'
    name: 'Louise Phone Living Room'

  - platform: mqtt
    state_topic: 'monitor/familyroom/90:60:F1:4E:07:61'
    value_template: '{{ value_json.confidence }}'
    unit_of_measurement: '%'
    name: 'Louise Phone Family Room'

  - platform: mqtt
    state_topic: 'monitor/livingroom/63:2C:C4:07:48:80'
    value_template: '{{ value_json.confidence }}'
    unit_of_measurement: '%'
    name: 'Louise Pace Maker Living Room'

  - platform: mqtt
    state_topic: 'monitor/familyroom/63:2C:C4:07:48:80'
    value_template: '{{ value_json.confidence }}'
    unit_of_measurement: '%'
    name: 'Louise Pace Maker Family Room'

  - platform: mqtt
    state_topic: 'monitor/livingroom/DD:9D:F9:67:44:09'
    value_template: '{{ value_json.confidence }}'
    unit_of_measurement: '%'
    name: 'Laptop Case'

  - platform: mqtt
    state_topic: 'monitor/livingroom/F7:CD:E6:0F:50:D0'
    value_template: '{{ value_json.confidence }}'
    unit_of_measurement: '%'
    name: 'F150 Truck Tile'

  - platform: min_max
    name: "Home Occupancy Confidence"
    type: max
    round_digits: 0
    entity_ids:
      - sensor.jerry_home
      - sensor.jerry_family_room
      - sensor.louise_phone_living_room
      - sensor.louise_phone_family_room
      - sensor.louise_pace_maker_living_room
      - sensor.louise_pace_maker_family_room

binary_sensor rfx433_pir1:
  - platform: template
    sensors:
      rfx433_pir1:
        friendly_name: 'rfx433_pir1'
        value_template: "{{ is_state('sensor.rfx433', 'EBC9FE') }}"
        delay_off: '00:00:01'
        device_class: motion

# mqtt_eventstream:
#  publish_topic:                    ha1
#  subscribe_topic:                  OtherHaServerName

#mqtt_publish:
#  host:                             bw.mtncad.com
#  host:                             localhost
#  port:                             1883
#  client_id:                        ha
#  username:                         ha
#  password:                         homeassistant
#  qos:                              0
#  include:                          sensor,binary_sensor,switch
#  exclude_regex:                    _cam|_pir_|_sourcenodeid_|dark_sky|_burglar_|_alarm_|^time$
#  json_payload:                     True

#  platform:

binary_sensor fr_camera:
  - platform: template
    sensors:
      lr_camera_motion_detected:
        friendly_name: "LR Camera Motion Detected"
        value_template: >-
          {{ states('sensor.living_room_motion_detected') == 'True' }}

#TODO: https://www.home-assistant.io/components/light.template/

sensor timed_switch:
  - platform:                          timed_switch
    switches:
      living_room_countdown_timer:
        name: Living Room Timed Light
        sensors:                       binary_sensor.lr_pir_motion,binary_sensor.lr_camera_motion_detected
        enable_switch:                 switch.lr_light_auto
        switch:                        switch.lr_sconce
        restart:                       False

      family_room_countdown_timer:
        name: Family Room Timed Light
        sensors:                       binary_sensor.fr_side_pir_motion,binary_sensor.fr_corner_pir_motion_2,binary_sensor.rfx433_pir1
        enable_switch:                 switch.fr_light_auto
        switch:                        switch.family_room_light
        restart:                       True

      garage_countdown_timer:
        name: Garage Timed Light
        sensors:                       binary_sensor.garage_side_pir_motion,binary_sensor.garage_back_pir_motion
        switch:                        switch.garage_light
        enable_switch:                 switch.garage_light_auto
        restart:                       True

      patio_countdown_timer:
        name:                          Patio Timed Light
        sensors:                       binary_sensor.patio_pir_motion
        switch:                        switch.patio_light
        enable_switch:                 switch.patio_light_auto
        delay:                         5

      back_driveway_countdown_timer:
        name:                          Back Driveway Timed Light
        sensors:                       binary_sensor.back_driveway_pir_motion
        switch:                        switch.back_driveway_light
        enable_switch:                 switch.back_driveway_auto
        delay:                         5

timer:
  fr_light:
    duration: '00:20:00'
    icon: mdi:timer-sand

#sensor glances:
#  - platform:                        glances
#    host:                            localhost
#    resources:
#      - 'disk_use_percent'
#      #- 'disk_use'
#      #- 'disk_free'
#      - 'memory_use_percent'
#      #- 'memory_use'
#      #- 'memory_free'
#      #- 'swap_use_percent'
#      #- 'swap_use'
#      #- 'swap_free'
#      - 'processor_load'
#      #- 'process_running'
#      - 'process_total'
#      - 'process_thread'
#      #- 'process_sleeping'
#      #- 'cpu_temp'

#From: https://www.home-assistant.io/components/cover.template/
cover:
  - platform: template
    covers:
      front_garage_door:
        friendly_name: "Front Garage Door"
        #check front PIR
        value_template: "{{ states('binary_sensor.ecolink_tilt_sensor_sensor_2') == 'on' }}"
        open_cover:
          service: script.toggle_front_garage_door
        close_cover:
          service: script.toggle_front_garage_door
        stop_cover:
          service: script.toggle_front_garage_door
      back_garage_door:
        friendly_name: "Back Garage Door"
        #check back PIR name
        value_template: "{{ states('binary_sensor.ecolink_tilt_sensor_sensor') == 'on' }}"
        open_cover:
          service: script.toggle_back_garage_door
        close_cover:
          service: script.toggle_back_garage_door
        stop_cover:
          service: script.toggle_back_garage_door

#cover front_garage_door:
#  platform: tilt
#  tilt_sensor:                   binary_sensor.front_garage_door_tilt_sensor
#  switch:                        switch.garage_door_switch
#  contact_delay:                 1
#  run_time:                      10

## garage_door.py must be on PATH
#switch command_line:
#  platform:                         command_line
#  switches:
#    garage_door:
#      command_on:                   garage_door.py on
#      command_off:                  garage_door.py off
#      command_state:                garage_door.py
#      value_template:               '{{ value == "on" }}'
#      friendly_name:                Garage Door

#switch flashing:
#  platform:                         flashing
#  switches:
#    lr_flashing_light:
#      switch:                       switch.lr_wall_light_switch

## redo
#switch file:
#  platform:                         file
#  switches:
#    file_path:                      /tmp/FILE_TEST

# name of switch and initial state.
switch mock:
  platform:                          mock
  switches:
    FR Light Auto:                   on
    LR Light Auto:                   on
    LR Flashing Light:               off
    Garage Light Auto:               on
    Patio Light Auto:                on
    Back Driveway Auto:              on
#    Alarm Active:                   off
#    Alarm Sound:                    off
#    Someone Home:                   on

# Weather Prediction
#sensor Weather:
#  platform:                         yr

shelly:

# See https://gist.github.com/ispiropoulos/90a5f215e71f4dde635e3e3407fb5804
#switch shelly:
#  - platform: shelly
#    switches:
#      #Shelly1
#      front_garage_door_switch:
#        path:                         /relay/0 # (optional, defaults to /relay/0)
#        host:                         192.168.10.70
#        username:                     jerry
#        password:                     !secret SHELLY_PASSWORD
#      #Shelly2
#      back_garage_door_switch:
#        path:                         /relay/0 # (optional, defaults to /relay/0)
#        host:                         192.168.10.71
#        username:                     jerry
#        password:                     !secret SHELLY_PASSWORD
      #Shelly3
      # fr_fan_switch:
      #   path:                         /relay/0 # (optional, defaults to /relay/0)
      #   host:                         192.168.10.72
      #   username:                     jerry
      #   password:                     !secret SHELLY_PASSWORD

#weather darksky:
#  - platform:                        darksky
#    api_key:                         !secret DARKSKY_API_KEY
#    mode:                            daily

weather openweathermap:
  - platform:                        openweathermap
    api_key:                         !secret open_weather_map_key
    mode:                            freedaily

#sensor darksky:
#  - platform:                        darksky
#    api_key:                         !secret DARKSKY_API_KEY
#    forecast:
#      - 1
#      - 7
#    scan_interval:
#      minutes:                       30
#    monitored_conditions:
#      - summary
#      - icon
#      - temperature
#      - humidity
#      - precip_probability
#      - precip_type
#      - precip_intensity
#      - wind_speed
#      - pressure
#      - wind_bearing
#      - apparent_temperature

#sensor ambient:
#  platform:                         ambient
#  host:                             192.168.10.35
##  update_interval:                 60
##  exclude:                         yearly_rain,indoor_sensor,outdoor_sensor1,outdoor_sensor2,unnamed_device,uv,uvi
##  prefix:                          ''

#device_tracker:
#  - platform:                        owntracks
#owntracks:
#  max_gps_accuracy:                250
#  waypoints:                       True

#  - platform: tile
#    username: jerry.workman@gmail.com
#    password: !secret TILE_PASSWORD
    
#  - platform:                        nmap_tracker
#    hosts:                           192.168.10.194/32, 192.168.10.201/32
#    #Louise: 192.168.10.201 #Jerry: 192.168.10.194
#    home_interval:                   10

# This will override the default home zone
zone:
  - name:                              Home
    latitude:                          38.340593
    longitude:                         -81.603318
    radius:                            200
    icon:                              mdi:home

  - name:                              Office
    latitude:                          38.350802
    longitude:                         -81.625556
    radius:                            150
    icon:                              mdi:office

  - name:                              Bailey
    latitude:                          38.351180
    longitude:                         -81.637878
    radius:                            150
    icon:                              mdi:office

#remote:
#  - platform:                       harmony
#    name:                           Living Room
#    host:                           192.168.10.130
    
#  - platform:                        harmony
#    name:                            Living Room
#    activity:                        Watch TV
#    host:                            192.168.10.130

#sensor harmony_living_room:
#  - platform:                        template
#    sensors:
#      harmony_living_room:
#        value_template:              '{{ states.remote.living_room.attributes.current_activity }}'

zwave:                               !include zwave.yaml

camera:                              !include camera.yaml

envisalink:                          !include envisalink.yaml

#weblink:                             !include weblink.yaml

sensor integration:
  - platform: integration
    source: sensor.power_meter
    name: Power Meter W
#    unit_prefix: W
    round: 0

# Example configuration.yaml entry
utility_meter:
  energy:
    source: sensor.power_meter
    cycle: monthly

sensor statistics:
  - platform: statistics
#    name: sensor.power_meter.stats
    entity_id: sensor.power_meter
    max_age:
      minutes: 60
    precision: 0

sensor influxdb:
  platform:                          influxdb
  host:                              localhost
  queries:
    #SELECT mean("value") AS "mean_value" FROM "home_assistant"."autogen"."Watts" WHERE time > now() - 1h
    #GROUP BY time(10s) FILL(null)
    #SELECT mean("value") AS "mean_value" FROM "home_assistant"."autogen"."Watts"
    #WHERE time > :dashboardTime: AND "entity_id"='power_meter' GROUP BY :interval: FILL(null)
#    - name:                         last value of meter watts
#      unit_of_measurement:          watts
    - name:                          Meter Avg for last hour
      unit_of_measurement:           'Watts'
      value_template:                '{{ float(value)| round(0) }}'
      group_function:                mean
#TODO: account for frequency value change time since last update
      where:                         '"entity_id" = ''power_meter'' and time > now() - 1h and value >= 0'
#      where:                         '"name" = ''power_meter'' and time > now() - 1h'
      measurement:                   '"home_assistant"."autogen"."Watts"'
      field:                         value
      database:                      home_assistant
#      value_template:               '{{ value | round(0) }}'
#      group_function:               last
#      where:                        '"entity_id" = ''power_meter'''
#      #measurement:                 '"Watts"'
#      measurement:                  '"home_assistant"."autogen"."Watts"'
#      field:                        value
#      database:                     home_assistant

    - name:                          Meter KWH for Last 24 hr
      unit_of_measurement:           'KWH'
      value_template:                '{{ (float(value) / 24000) | round(0) }}'
      group_function:                sum
      where:                         '"entity_id" = ''power_meter'' and time > now() - 24h and value >= 0'
      measurement:                   '"home_assistant"."autogen"."Watts"'
      field:                         value
      database:                      home_assistant
      
    - name:                          Down Heat Pump Avg
      unit_of_measurement:           'Watts'
      value_template:                '{{ float(value) | round(0) }}'
      group_function:                mean
      where:                         '"entity_id" = ''down_heat_pump'' and time > now() - 1h and value >= 0'
      measurement:                   '"home_assistant"."autogen"."Watts"'
      field:                         value
      database:                      home_assistant
      
    - name:                          Down Air Handler Avg
      unit_of_measurement:           'Watts'
      value_template:                '{{ float(value) | round(0) }}'
      group_function:                mean
      where:                         '"entity_id" = ''down_air_handler'' and time > now() - 1h and value >= 0'
      measurement:                   '"home_assistant"."autogen"."Watts"'
      field:                         value
      database:                      home_assistant
      
    - name:                          Up Heat Pump Avg
      unit_of_measurement:           'Watts'
      value_template:                '{{ float(value) | round(0) }}'
      group_function:                mean
      where:                         '"entity_id" = ''up_heat_pump'' and time > now() - 1h and value >= 0'
      measurement:                   '"home_assistant"."autogen"."Watts"'
      field:                         value
      database:                      home_assistant
      
########### in postgresql ############
#select
#  state,
#  created - lead(created) OVER (ORDER BY created DESC) as duration
#  from states
#where entity_id = 'sensor.power_meter'
#    and state <> 'unknown'
#    and created > now() - interval '1 hour'
#  order by created;
######### 107 mseconds ########

    - name:                          Daily Power Cost
      unit_of_measurement:           '$/day'
      # 24 hrs * .094 cents/KWH / 1000 W/KW = 0.002256 $/day
      value_template:                '{{ (float(value) * 0.002256) | round(2) }}'
      group_function:                mean
      where:                         '"entity_id" = ''power_meter'' and time > now() - 24h'
      measurement:                   '"home_assistant"."autogen"."Watts"'
      field:                         value
      database:                      home_assistant

    # - name:                          Daily Internet Download
    #   unit_of_measurement:           'Mb'
    #   value_template:                '{{ (float(value) * 0.002256) | round(2) }}'
    #   group_function:                mean
    #   where:                         '"entity_id" = ''power_meter'' and time > now() - 24h'
    #   measurement:                   '"home_assistant"."autogen"."Watts"'
    #   field:                         value
    #   database:                      home_assistant



binary_sensor 1:
  platform:                          command_line
#  command:                           'ping -c 1 192.168.10.228 | grep "1 received" | wc -l'
  command:                           'nmap -Pn -p 80 192.168.10.52  | grep 80 | wc -l'
  name:                              'Front Cam Online'
  payload_on:                        1
  payload_off:                       0


binary_sensor 2:
  platform:                          command_line
#  command:                          'ping -c 1 192.168.10.56 | grep "1 received" | wc -l'
  command:                           'nmap -p 80 192.168.10.56 | grep 80 | wc -l'
  name:                              'Back Cam Online'
  payload_on:                        1
  payload_off:                       0

binary_sensor ping_google:
  name: 'Ping Google'
  platform: ping
  host: 1.1.1.1
#  count: 2
  scan_interval: 30

sensor ping_google:
  - platform: template
    sensors:
        google_ping_latency:
          friendly_name: 'Google Ping Latency'
          value_template: "{{ state_attr('binary_sensor.ping_google', 'round_trip_time_avg') }}"
          unit_of_measurement: 'ms'

binary_sensor ping_hawk:
  name: 'Ping hawk'
  platform: ping
  host: hawk
#  count: 2
  scan_interval: 30

sensor ping_hawk:
  - platform: template
    sensors:
        hawk_ping_latency:
          friendly_name: 'hawk Ping Latency'
          value_template: "{{ state_attr('binary_sensor.ping_hawk', 'round_trip_time_avg') }}"
          unit_of_measurement: 'ms'


binary_sensor lr_cam_online:
  platform:                          command_line
#  command:                          'ping -c 1 192.168.10.51 | grep "1 received" | wc -l'
  command:                           'nmap -p 80 192.168.10.51 | grep 80 | wc -l'
  name:                              'LR Cam Online'
  payload_on:                        1
  payload_off:                       0


binary_sensor fr_cam_online:
  platform:                          command_line
#  command:                          'ping -c 1 192.168.10.54 | grep "1 received" | wc -l'
  command:                           'nmap -p 80 192.168.10.54 | grep 80 | wc -l'
  name:                              'FR Cam Online'
  payload_on:                        1
  payload_off:                       0


binary_sensor garage_cam_online:
  platform:                          command_line
#  command:                          'ping -c 1 192.168.10.55 | grep "1 received" | wc -l'
  command:                           'nmap -p 80 192.168.10.55 | grep 80 | wc -l'
  name:                              'Garage Cam Online'
  payload_on:                        1
  payload_off:                       0

binary_sensor garage_freeze_alert:
  - platform:                        template
    sensors:
      garage_freeze_alert:
        friendly_name:               "Garage Freeze Alert"
        value_template:              >-
          {{ states('sensor.garage_temperature')|float <= 32.0
            and states('sensor.garage_temperature') }}

binary_sensor outdoor_freeze_alert:
  - platform:                        template
    sensors:
      outdoor_freeze_alert:
        friendly_name:               "Outdoor Freeze Alert"
        value_template:              >-
          {{ states('sensor.out_temperature')|float <= 32.0 }}
#            and states('sensor.out_temperature') }}
          
sensor temp_diff:
  - platform:                        template
    sensors:
      temp_diff:
        friendly_name:               "(Inside - Outside) Temp Diff"
        # positive value = inside warmer than outside
        unit_of_measurement: 'degF'
        value_template:              >-
          {{ (states('sensor.lr_temperature')|float - states('sensor.out_temperature')|float) | round(2)  }}

sensor hvac_mode:
  - platform:                        template
    sensors:
      hvac_mode:
        friendly_name:               "HVAC Mode"
        value_template:              >-
          {{ states('climate.living_room.attributes.operation_mode') }}
#          {{ states('climate.living_room.operation_mode') }}

sensor ventilator_fan_on:
  - platform:                        template
    sensors:
      ventilator_fan_on:
        friendly_name:               "Turn Ventilator On"
        value_template:              >-
          {{ ((states('temp_diff')|float >= 1.0) and (states('hvac_mode') == 'cool'))
            or ((states('temp_diff')|float <= -1.0) and (states('hvac_mode') == 'heat')) }}


#binary_sensor mfi_online:
#  platform:                         command_line
#  command:                          'nmap -p 6080 mcoyne50.ddns.net | grep 6080 | wc -l'
#  name:                             "Mike's mFi Online"
#  payload_on:                       1
#  payload_off:                      0


#Make sure login is correct or it will say that you are rate limited
climate LR:
  platform:                         honeywell
  username:                         jerry.workman@gmail.com
  password:                         !secret HONEYWELL_PASSWORD
  region:                           us
  scan_interval:                    600
  away_cool_temperature:            80
  away_heat_temperature:            66
    
#  platform:                         radiotherm
#  host:
#    - 192.168.10.175
#  hold_temp:                        True


#firetv-server -d 192.168.10.25:5555 &
#media_player lr-firetv:
#  platform:                         firetv
#  host:                             localhost
#  port:                             5556
#  device:                           default
#  name:                             LR Fire TV

speedtestdotnet:
  server_id:                        5434
  scan_interval:
    days: 0
    hours: 0
    minutes: 30
    seconds: 0
    milliseconds: 0
  monitored_conditions:
    - ping
    - download
    - upload
    
rfxtrx:
  device:                            /dev/rfxcom
  debug:                             True
# device:                            /dev/ttyUSB1
# device:                            /dev/serial/by-id/usb-RFXCOM_RFXrec433_04XOSET4-if00-port0
# set by udev rule. see:             http://domogik-plugin-ozwave.readthedocs.io/en/master/ozwave.html#create-the-udev-rule-for-controller
# dummy:                             False

#Device_id: f304
#Device_id: d101
#Device_id: 1e02
#Device_id: ed04
#Device_id: 5404

binary_sensor rfxtrx_binary:
  platform: rfxtrx
  automatic_add: true

sensor rfxtrx:
  platform:                          rfxtrx
  automatic_add:                     True
  value_template:                    "{{ value|round(1) }}"
  devices:
#    0a5201021e0200d8150269:
#    0a52014dee0400fa370179:
#    0a52010cf10200fc380059:
    0a52010af10200fa390159:
      name:                          UP # sensor.up_temperature
    # d101
    0a520152d10101053d0059:
      name:                          Out
    # ed04
#    0a520102ed0400d6370169:
    0a52010dba0400d2270269:
      name:                          FR
    # f304
#    0a520103f3040060170269:
    0a52010de20401043c0069:
       name:                         Garage
    # ee04
    #0a520103ee0400d83c0169:
    #  name:                          Old LR
  # bf04
    0a520110bf0400d7200279:
      name:                          LR

      data_type:
       - Humidity
       - Temperature

configurator:

#  philips_hue

#light hue1:
#  platform:                         hue
#  host:                             192.168.10.169
#  allow_unreachable:                false
#  filename:                         my_hue_hub_token.conf

#sensor temp:
#  - platform:                       template
#    sensors:
#      lr_temperature:
#        #states.switch.kettle.attributes.kwh
#        #value_template:            '{{ "%.1f"|format(float(states.sensor.lr.state)) }}'
#        value_template:             '{{ "%.1f"|format(float(states.sensor.lr.state)) }}'
#        friendly_name:              'LR Temp'
#        #unit_of_measurement:       "\u2109"
#        unit_of_measurement:        'degF'
#      fr_temperature:
#        value_template:             '{{ "%.1f"|format(float(states.sensor.fr.state)) }}'
#        friendly_name:              'FR Temp'
#        #unit_of_measurement:       '\u2109'
#        unit_of_measurement:        'degF'
#      out_temperature:
#        value_template:             '{{ "%.1f"|format(float(states.sensor.out.state)) }}'
#        friendly_name:              'Out Temp'
#        #unit_of_measurement:       '\u2109'
#        unit_of_measurement:        'degF'

#hdmi_cec:
#  devices:
#    TV:                             2.0.0.0
    #Raspberry Pi:                   1.0.0.0
    #DirecTV DVR:                    2.0.0.0
    #Amazon Fire:                    f.f.f.f

wake_on_lan: # enables wake_on_lan domain

switch LG:
  - platform: wake_on_lan
    name: lg
#     mac_address: "aa:bb:cc:dd:ee:ff"
    mac: "A8:23:FE:6C:C2:5F"

media_player:
  - platform: vlc
    name: vlc
    arguments: '--alsa-audio-device=hw:0,0'

#media_player.living_room_lg_tv
media_player TV:
  - platform:                        webostv
    host:                            192.168.10.133
    name:                            Living Room LG TV
    device_class:                    tv
    filename:                        webostv.conf
    timeout:                         5
    
    turn_on_action:
      service: wake_on_lan.send_magic_packet
#      data:
#        mac: "A8:23:FE:6C:C2:5F"
    customize:
      sources:
        - livetv
        - directv
        - youtube
        - netflix

      turn_on_action:
        service: switch.turn_on
        entity_id: switch.lg


  - platform:                        vlc
    name:                            speaker
    arguments:                       '--alsa-audio-device=hw:0,0'

# Only the main box has an IP address
  - platform:                        directv
    host:                            192.168.10.60
    port:                            8080
    name:                            Living Room DTV
    device:                          0
  - platform:                        directv
    host:                            192.168.10.60
    port:                            8080
    name:                            Rec Room DTV
    device:                          D42C0FF18CBD
  - platform:                        directv
    host:                            192.168.10.60
    port:                            8080
    name:                            Master Bed Room DTV
    device:                          44AAF566A381


#alexa:
  #intents:

#timer:
#  flash_timer:
#    duration:                       '00:00:05'

input_boolean:
  kiosk_mode:
    name:                            Kiosk Mode
    initial:                         off
    icon:                            mdi:cast
  occupancy:
    name:                            Occupancy
    initial:                         on
    icon:                            mdi:human
    
#input_text:
#  command:
#    name:                            Button
#  light_tiles:
#    name:                            Buttons

input_number:
  garage_delay:
    name:                            Garage Light Delay
    initial:                         20
    min:                             5
    max:                             30
    step:                            5
  lr_delay:
    name:                            LR Light Delay
    initial:                         20
    min:                             5
    max:                             30
    step:                            5


#         {% elif is_state_attr("lock.kwikset_touchpad_electronic_deadbolt_locked", "lock_status", "Unlocked with Keypad by user 2") %}
#           U2
#         {% elif is_state_attr("lock.kwikset_touchpad_electronic_deadbolt_locked", "lock_status", "Locked with Keypad by user 2") %}
#           L2

# TODO:
# lock.schlage_be469_touchscreen_deadbolt_locked
#sensor lock_status:
#  - platform:                        template
#    sensors:
#      lock_side_door_battery:
#        friendly_name:               'Side Door Lock Battery'
#        value_template:              '{{ states.zwave.kwikset_touchpad_electronic_deadbolt.attributes.battery_level }}'
#        unit_of_measurement:         '%'
        #entity_id:                  zwave.kwikset_touchpad_electronic_deadbolt
#      lock_side_door_status:
#        friendly_name:               'Side Door Lock Status'
#        value_template:              '{{ states.lock.kwikset_touchpad_electronic_deadbolt_locked_2.attributes.lock_status }}'
#        #entity_id:                  lock.kwikset_touchpad_electronic_deadbolt_locked_2

#shell_command lovelace:
#  lovelace_gen: 'python /home/homeassistant/ha/lovelace-gen.py'

history_graph:
  voltage:
    name: Line Voltage
    refresh: 300
    entities:
      - sensor.line_voltage
  power:
    name: Power Meter
    refresh: 300
    entities:
       - sensor.power_meter
  down_heat_pump:
    name: Down Heat Pump
    refresh: 300
    entities:
      - sensor.down_heat_pump
  out_temperaturess:
    name: Outside Temperature
    refresh: 300
    entities:
      - sensor.out_temperature

person:
  - name: Jerry
    id: jw
    user_id: 6d121fa286574a83af0680973aa79f3c
    device_trackers:
      - device_tracker.life360_jerry_workman
      
  - name: Louise
    id: lc
#    user_id: 2
    device_trackers:
      - device_tracker.life360_louise_cleek


life360:
  accounts:
    - username: !secret life360_username
      password: !secret life360_password
  driving_speed: 18
  interval_seconds: 10
  max_gps_accuracy: 250
  max_update_wait:
    minutes: 45
  show_as_state:
    - driving
    - moving
  # Set comm error thresholds so first is not logged,
  # second is logged as a WARNING, and third and fourth
  # are logged as ERRORs.
  warning_threshold: 2
  error_threshold: 3

#device_tracker: # Using mqtt and monitor.sh now
#  - platform: bluetooth_tracker

#alexa_media:
#  accounts:
#    - email: !secret amazon_user
#      password: !secret amazon_password
#      url: amazon.com

# camera streaming
stream:

intent_script:                       !include intent_script.yaml

# automation:                          !include_dir_list automation/

automation old:                       !include_dir_merge_list automation_merged/

automation:                          !include automations.yaml

script:                              !include scripts.yaml

group:                               !include group.yaml

scene:                               !include scenes.yaml
    